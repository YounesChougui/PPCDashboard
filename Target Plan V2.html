<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Marketing Performance Dashboard</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A lighter gray (slate-50) */
        }
        /* Custom styles for positive/negative/neutral indicators */
        .kpi-positive { color: #16a34a; /* green-600 */ }
        .kpi-negative { color: #dc2626; /* red-600 */ }
        .kpi-neutral { color: #64748b; /* slate-500 */ }

        .kpi-bg-positive { background-color: #dcfce7; /* green-100 */ }
        .kpi-bg-negative { background-color: #fee2e2; /* red-100 */ }
        
        .kpi-pill {
            padding: 4px 10px;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
            display: inline-block;
        }
        
        /* Style for chart containers to ensure they are responsive */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        /* Style for table inputs */
        .input-table-cell {
            padding: 8px 4px !important;
        }
        .input-table-field {
             width: 100%;
             padding: 8px;
             border-radius: 6px;
             border: 1px solid #cbd5e1; /* slate-300 */
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-table-field:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px #c7d2fe; /* indigo-200 */
        }
        /* New styles for target plan cards */
        .target-card {
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            border: 1px solid #e2e8f0;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .target-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <header>
            <h1 class="text-4xl font-bold text-gray-800">Marketing Performance Dashboard</h1>
            <p id="dashboard-month" class="text-gray-500 mt-1 text-lg">August 2025</p>
        </header>

        <!-- Section 1: Target Plan -->
        <section>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Target Plan</h2>
            <div id="target-plan-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Target plan cards are generated by JS -->
            </div>
        </section>

        <!-- Section 2: Actuals Input -->
        <section class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Enter Actual Performance</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Location</th>
                            <th scope="col" class="px-6 py-3">Actual Business Leads</th>
                            <th scope="col" class="px-6 py-3">Actual Spend</th>
                        </tr>
                    </thead>
                    <tbody id="actual-input-table">
                        <!-- Input rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Section 3: Performance Comparison -->
        <section class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Performance Comparison: Target vs. Actual</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3">Location</th>
                            <th class="px-4 py-3">Target Leads</th>
                            <th class="px-4 py-3">Actual Leads</th>
                            <th class="px-4 py-3">Leads Variance</th>
                            <th class="px-4 py-3">Target CPBL</th>
                            <th class="px-4 py-3">Actual CPBL</th>
                            <th class="px-4 py-3">CPBL Variance</th>
                            <th class="px-4 py-3">Target Budget</th>
                            <th class="px-4 py-3">Actual Spend</th>
                            <th class="px-4 py-3">Budget Variance</th>
                        </tr>
                    </thead>
                    <tbody id="comparison-table">
                         <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Section 4: Month-over-Month Comparison -->
        <section class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Month-over-Month Performance (August vs. July)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Location</th>
                            <th scope="col" class="px-6 py-3">August Leads</th>
                            <th scope="col" class="px-6 py-3">July Leads</th>
                            <th scope="col" class="px-6 py-3">Leads % Change</th>
                            <th scope="col" class="px-6 py-3">August CPBL</th>
                            <th scope="col" class="px-6 py-3">July CPBL</th>
                            <th scope="col" class="px-6 py-3">CPBL % Change</th>
                        </tr>
                    </thead>
                    <tbody id="mom-performance-table">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Section 5: Visual Analysis -->
        <section>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Visual Analysis</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Budget: Actual Spend vs. Target</h3>
                    <div class="chart-container"><canvas id="budgetChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Leads: Actual vs. Target</h3>
                    <div class="chart-container"><canvas id="leadsChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Cost Per Business Lead (CPBL): Actual vs. Target</h3>
                    <div class="chart-container"><canvas id="cpblChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Budget Variance</h3>
                    <p class="text-sm text-gray-500 mb-4">How much each country was over or under budget.</p>
                    <div class="chart-container"><canvas id="budgetVarianceChart"></canvas></div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- DATA INITIALIZATION ---
        // Target Budget and Target CPBL are the source of truth. Target Leads are calculated.
        const performanceData = {
            'DE': { name: 'Germany', currencySymbol: '£', currencyCode: 'GBP', targetBudget: 10404, targetCpbl: 100, julyLeads: 72, julyCpbl: 149, actualLeads: 0, actualSpend: 0 },
            'PT': { name: 'Portugal', currencySymbol: '€', currencyCode: 'EUR', targetBudget: 7644, targetCpbl: 90, julyLeads: 33, julyCpbl: 228, actualLeads: 0, actualSpend: 0 },
            'ES': { name: 'Spain', currencySymbol: '€', currencyCode: 'EUR', targetBudget: 14500, targetCpbl: 110, julyLeads: 68, julyCpbl: 210, actualLeads: 0, actualSpend: 0 },
            'IT': { name: 'Italy', currencySymbol: '£', currencyCode: 'GBP', targetBudget: 10404, targetCpbl: 70, julyLeads: 114, julyCpbl: 117, actualLeads: 0, actualSpend: 0 },
        };

        let charts = {}; // Object to hold all chart instances

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value, code, symbol) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: code, symbol: symbol }).format(value);
        };
        
        const createVariancePill = (value, formatFn, isInverseGood = false) => {
            const isPositive = value > 0;
            const isZero = value === 0;
            let className = '';

            if (isZero) {
                className = 'kpi-neutral bg-slate-100';
            } else if ((isPositive && !isInverseGood) || (!isPositive && isInverseGood)) {
                className = 'kpi-positive kpi-bg-positive';
            } else {
                className = 'kpi-negative kpi-bg-negative';
            }
            return `<span class="kpi-pill ${className}">${formatFn(value)}</span>`;
        };
        
        const createPercentagePill = (value, isInverseGood = false) => {
             if (isNaN(value) || !isFinite(value)) return `<span class="kpi-pill kpi-neutral bg-slate-100">-</span>`;
             return createVariancePill(value, val => `${val > 0 ? '+' : ''}${val.toFixed(0)}%`, isInverseGood);
        };

        // --- CORE LOGIC ---
        function calculateAllMetrics() {
            Object.values(performanceData).forEach(country => {
                // Base metrics - Target Leads are now calculated
                country.targetLeads = Math.round(country.targetBudget / country.targetCpbl);
                country.actualCpbl = country.actualLeads > 0 ? country.actualSpend / country.actualLeads : 0;
                
                // Variance metrics
                country.budgetVariance = country.actualSpend - country.targetBudget;
                country.leadsVariance = country.actualLeads - country.targetLeads;
                country.cpblVariance = country.actualCpbl - country.targetCpbl;

                // MoM metrics
                country.momLeadsChange = country.julyLeads > 0 ? ((country.actualLeads - country.julyLeads) / country.julyLeads) * 100 : (country.actualLeads > 0 ? Infinity : 0);
                country.momCpblChange = country.julyCpbl > 0 ? ((country.actualCpbl - country.julyCpbl) / country.julyCpbl) * 100 : (country.actualCpbl > 0 ? Infinity : 0);
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderTargetPlanSection() {
            const section = document.getElementById('target-plan-section');
            section.innerHTML = '';
            Object.values(performanceData).forEach(c => {
                const card = `
                    <div class="target-card p-6 rounded-xl shadow-sm flex flex-col justify-between">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800">${c.name}</h3>
                                <span class="text-2xl">${c.currencySymbol === '€' ? 'EUR' : 'GBP'}</span>
                            </div>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Target Budget</span>
                                    <span class="font-semibold text-gray-700">${formatCurrency(c.targetBudget, c.currencyCode, c.currencySymbol)}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500">Target CPBL</span>
                                    <span class="font-semibold text-gray-700">${formatCurrency(c.targetCpbl, c.currencyCode, c.currencySymbol)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-gray-500 text-sm">Target Leads</p>
                            <p class="text-3xl font-bold text-indigo-600">${c.targetLeads}</p>
                        </div>
                    </div>`;
                section.innerHTML += card;
            });
        }

        function renderActualInputTable() {
            const tbody = document.getElementById('actual-input-table');
            tbody.innerHTML = '';
            Object.keys(performanceData).forEach(key => {
                const c = performanceData[key];
                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${c.name}</td>
                        <td class="px-6 py-4 input-table-cell">
                            <input type="number" data-country="${key}" data-type="actualLeads" class="input-table-field" placeholder="0" min="0">
                        </td>
                        <td class="px-6 py-4 input-table-cell">
                            <input type="number" data-country="${key}" data-type="actualSpend" class="input-table-field" placeholder="0.00" min="0" step="0.01">
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderComparisonTable() {
            const tbody = document.getElementById('comparison-table');
            tbody.innerHTML = '';
            Object.values(performanceData).forEach(c => {
                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50 text-center">
                        <td class="px-4 py-4 font-medium text-gray-900 text-left">${c.name}</td>
                        <td class="px-4 py-4">${c.targetLeads}</td>
                        <td class="px-4 py-4 font-bold">${c.actualLeads}</td>
                        <td class="px-4 py-4">${createVariancePill(c.leadsVariance, val => `${val > 0 ? '+' : ''}${val}`)}</td>
                        <td class="px-4 py-4">${formatCurrency(c.targetCpbl, c.currencyCode, c.currencySymbol)}</td>
                        <td class="px-4 py-4 font-bold">${formatCurrency(c.actualCpbl, c.currencyCode, c.currencySymbol)}</td>
                        <td class="px-4 py-4">${createVariancePill(c.cpblVariance, val => formatCurrency(val, c.currencyCode, c.currencySymbol), true)}</td>
                        <td class="px-4 py-4">${formatCurrency(c.targetBudget, c.currencyCode, c.currencySymbol)}</td>
                        <td class="px-4 py-4 font-bold">${formatCurrency(c.actualSpend, c.currencyCode, c.currencySymbol)}</td>
                        <td class="px-4 py-4">${createVariancePill(c.budgetVariance, val => formatCurrency(val, c.currencyCode, c.currencySymbol), true)}</td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderMomTable() {
            const tbody = document.getElementById('mom-performance-table');
            tbody.innerHTML = '';
            Object.values(performanceData).forEach(c => {
                const row = `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900">${c.name}</td>
                        <td class="px-6 py-4 font-bold">${c.actualLeads}</td>
                        <td class="px-6 py-4">${c.julyLeads}</td>
                        <td class="px-6 py-4">${createPercentagePill(c.momLeadsChange)}</td>
                        <td class="px-6 py-4 font-bold">${formatCurrency(c.actualCpbl, c.currencyCode, c.currencySymbol)}</td>
                        <td class="px-6 py-4">${formatCurrency(c.julyCpbl, c.currencyCode, c.currencySymbol)}</td>
                        <td class="px-6 py-4">${createPercentagePill(c.momCpblChange, true)}</td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderAllCharts() {
            const labels = Object.values(performanceData).map(c => c.name);
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { callback: (value) => (typeof value === 'number' ? value.toLocaleString() : value) } } },
                plugins: { legend: { position: 'top' } }
            };

            // Destroy existing charts before redrawing
            Object.values(charts).forEach(chart => chart?.destroy());

            // Budget Chart
            charts.budgetChart = new Chart(document.getElementById('budgetChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Actual Spend', data: Object.values(performanceData).map(c => c.actualSpend), backgroundColor: '#3b82f6', barPercentage: 0.6 },
                        { label: 'Target Budget', data: Object.values(performanceData).map(c => c.targetBudget), backgroundColor: '#d1d5db', barPercentage: 0.6 }
                    ]
                },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.raw, 'EUR', '€')}` }}}}
            });

            // Leads Chart
            charts.leadsChart = new Chart(document.getElementById('leadsChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Actual Leads', data: Object.values(performanceData).map(c => c.actualLeads), backgroundColor: '#16a34a', barPercentage: 0.6 },
                        { label: 'Target Leads', data: Object.values(performanceData).map(c => c.targetLeads), backgroundColor: '#d1d5db', barPercentage: 0.6 }
                    ]
                },
                options: chartOptions
            });
            
            // CPBL Chart
            charts.cpblChart = new Chart(document.getElementById('cpblChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Actual CPBL', data: Object.values(performanceData).map(c => c.actualCpbl), backgroundColor: '#ef4444', barPercentage: 0.6 },
                        { label: 'Target CPBL', data: Object.values(performanceData).map(c => c.targetCpbl), backgroundColor: '#d1d5db', barPercentage: 0.6 }
                    ]
                },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.raw, 'EUR', '€')}` }}}}
            });

            // Budget Variance Chart
            charts.budgetVarianceChart = new Chart(document.getElementById('budgetVarianceChart'), {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        label: 'Budget Variance',
                        data: Object.values(performanceData).map(c => c.budgetVariance),
                        backgroundColor: ['#16a34a', '#3b82f6', '#ef4444', '#f97316'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.raw, 'EUR', '€')} ${c.raw > 0 ? 'Over' : 'Under'}` }}
                    }
                }
            });
        }

        function updateAll() {
            calculateAllMetrics();
            renderTargetPlanSection();
            renderComparisonTable();
            renderMomTable();
            renderAllCharts();
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            renderActualInputTable(); // Render inputs first
            updateAll(); // Then calculate and render everything else

            const inputTable = document.getElementById('actual-input-table');
            inputTable.addEventListener('input', (event) => {
                const { country, type } = event.target.dataset;
                if (country && type) {
                    performanceData[country][type] = parseFloat(event.target.value) || 0;
                    updateAll();
                }
            });
        });

    </script>
</body>
</html>
